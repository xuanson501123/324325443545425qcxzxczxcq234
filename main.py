import os, json, asyncio, subprocess
from keep_alive import keep_alive
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters, CallbackQueryHandler, ConversationHandler
)

# === C·∫•u h√¨nh ===
BOT_TOKEN = "7905209230:AAF-AnSHZWih_7VYa_7VhkSPn7epyn3whIU"
AUTHORIZED_IDS = [5252425303, 6172090155]
REPO_PATH = ""
JSON_FILE = "index/accounts.json"
GIT_COMMIT_MESSAGE = "C·∫≠p nh·∫≠t UDID: "

# === Tr·∫°ng th√°i cho ConversationHandler ===
WAITING_CUSTOM_DAYS = 1

# === T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a c√≥ ===
os.makedirs(os.path.join(REPO_PATH, "index"), exist_ok=True)

# === H√†m ti·ªán √≠ch ===
def get_file_path():
    return os.path.join(REPO_PATH, JSON_FILE)

def load_udid_data():
    if os.path.exists(get_file_path()):
        with open(get_file_path(), "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

def save_udid_data(data):
    with open(get_file_path(), "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)

def git_commit_and_push(msg):
    token = os.getenv("GH_TOKEN")
    user = os.getenv("GH_USER")
    repo = os.getenv("GH_REPO")

    if not all([token, user, repo]):
        print("‚ùå Thi·∫øu GH_TOKEN, GH_USER ho·∫∑c GH_REPO")
        return

    remote_url = f"https://{user}:{token}@github.com/{user}/{repo}.git"

    subprocess.run(["git", "config", "--global", "user.name", user], check=True)
    subprocess.run(["git", "config", "--global", "user.email", f"{user}@users.noreply.github.com"], check=True)
    subprocess.run(["git", "remote", "set-url", "origin", remote_url], check=True)

    try:
        subprocess.run(["git", "stash"], check=True)
        subprocess.run(["git", "pull", "--rebase", "origin", "main"], check=True)
        subprocess.run(["git", "stash", "pop"], check=True)
    except subprocess.CalledProcessError:
        print("‚ö†Ô∏è G·∫∑p l·ªói khi stash ho·∫∑c pull. Th·ª≠ ti·∫øp t·ª•c...")

    try:
        subprocess.run(["git", "add", get_file_path()], check=True)
        subprocess.run(["git", "commit", "-m", msg], check=True)
        subprocess.run(["git", "push", "--force", "origin", "main"], check=True)
        print("‚úÖ ƒê√£ ƒë·∫©y l√™n GitHub.")
    except subprocess.CalledProcessError as e:
        print("‚ùå G·∫∑p l·ªói khi push:", e)

def is_authorized(uid):
    return uid in AUTHORIZED_IDS

# === Bot Telegram ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("‚úÖ G·ª≠i UDID ƒë·ªÉ th√™m ho·∫∑c d√πng /delete <udid> ƒë·ªÉ xo√°.")

# Nh·∫≠n UDID t·ª´ user
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_authorized(update.effective_user.id):
        await update.message.reply_text("‚ùå Kh√¥ng c√≥ quy·ªÅn.")
        return

    udid = update.message.text.strip().upper()
    if not udid:
        await update.message.reply_text("‚ö†Ô∏è UDID kh√¥ng h·ª£p l·ªá.")
        return

    context.user_data["udid"] = udid  # L∆∞u t·∫°m UDID

    keyboard = [
        [InlineKeyboardButton("1 day", callback_data="days_1")],
        [InlineKeyboardButton("31 days", callback_data="days_31")],
        [InlineKeyboardButton("1000 days", callback_data="days_1000")],
        [InlineKeyboardButton("T√πy ch·ªânh", callback_data="custom_days")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(f"üìå Ch·ªçn th·ªùi h·∫°n cho UDID: {udid}", reply_markup=reply_markup)

# X·ª≠ l√Ω ch·ªçn n√∫t
async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    udid = context.user_data.get("udid")

    if not udid:
        await query.edit_message_text("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y UDID. H√£y g·ª≠i l·∫°i.")
        return

    if query.data.startswith("days_"):
        days = int(query.data.split("_")[1])
        expiry = (datetime.now() + timedelta(days=days)).strftime("%Y-%m-%d")

        data = load_udid_data()
        data[udid] = expiry
        save_udid_data(data)
        git_commit_and_push(GIT_COMMIT_MESSAGE + udid)

        await query.edit_message_text(
            f"‚úÖ ƒê√£ duy·ªát UDID: {udid}\nüìÖ H·∫°n d√πng: {expiry}\n‚è±Ô∏è Ch·ªù 3-5 ph√∫t c√≥ th·ªÉ s·ª≠ d·ª•ng Mod."
        )

    elif query.data == "custom_days":
        await query.edit_message_text("‚úèÔ∏è Nh·∫≠p s·ªë ng√†y b·∫°n mu·ªën c·∫•p:")
        return WAITING_CUSTOM_DAYS

# Nh·∫≠p s·ªë ng√†y t√πy ch·ªânh
async def custom_days(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        days = int(update.message.text.strip())
    except ValueError:
        await update.message.reply_text("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë nguy√™n h·ª£p l·ªá.")
        return WAITING_CUSTOM_DAYS

    udid = context.user_data.get("udid")
    if not udid:
        await update.message.reply_text("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y UDID. H√£y g·ª≠i l·∫°i.")
        return ConversationHandler.END

    expiry = (datetime.now() + timedelta(days=days)).strftime("%Y-%m-%d")
    data = load_udid_data()
    data[udid] = expiry
    save_udid_data(data)
    git_commit_and_push(GIT_COMMIT_MESSAGE + udid)

    await update.message.reply_text(
        f"‚úÖ ƒê√£ duy·ªát UDID: {udid}\nüìÖ H·∫°n d√πng: {expiry}\n‚è±Ô∏è Ch·ªù 3-5 ph√∫t c√≥ th·ªÉ s·ª≠ d·ª•ng Mod."
    )
    return ConversationHandler.END

# /delete udid
async def delete_udid(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_authorized(update.effective_user.id):
        await update.message.reply_text("‚ùå Kh√¥ng c√≥ quy·ªÅn.")
        return
    if not context.args:
        await update.message.reply_text("‚ö†Ô∏è D√πng: /delete <udid>")
        return

    udid = context.args[0].strip().upper()
    data = load_udid_data()
    if udid in data:
        del data[udid]
        save_udid_data(data)
        git_commit_and_push(f"Xo√° UDID: {udid}")
        await update.message.reply_text(f"üóë ƒê√£ xo√° {udid}")
    else:
        await update.message.reply_text("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y UDID.")

# === Kh·ªüi ch·∫°y Bot ===
async def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)],
        states={
            WAITING_CUSTOM_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, custom_days)]
        },
        fallbacks=[],
        map_to_parent={}
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("delete", delete_udid))
    app.add_handler(conv_handler)
    app.add_handler(CallbackQueryHandler(button_callback))

    print("‚úÖ Bot ƒëang ch·∫°y...")
    await app.run_polling()

if __name__ == "__main__":
    import nest_asyncio
    nest_asyncio.apply()
    keep_alive()
    print("‚úÖ Server ƒëang ch·∫°y...")
    asyncio.get_event_loop().run_until_complete(main())
